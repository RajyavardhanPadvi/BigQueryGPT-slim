<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>BigQueryGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:Inter,Arial;background:#071027;color:#e6f7fb;margin:0}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .hint{color:#9fd6e6;font-size:0.9rem}
    .btn{background:#2ec4ff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .zone{margin-top:14px;border:2px dashed #2ec4ff;padding:18px;border-radius:12px;text-align:center}
    .chat{margin-top:20px;background:#071827;border:1px solid #123245;border-radius:10px;padding:12px}
    .msg{margin:8px 0;padding:8px;border-radius:8px;max-width:80%}
    .user{margin-left:auto;background:#0e2f4a}
    .bot{margin-right:auto;background:#0b1f33}
    .row{display:flex;gap:8px;align-items:center}
    input[type=text]{flex:1;border-radius:8px;border:1px solid #2b4d66;background:#0b1b2b;color:#e6f7fb;padding:8px}
    pre{white-space:pre-wrap;color:#bfefff}
  </style>
</head>
<body>
<div class="wrap">
  <h2>BigQueryGPT</h2>
  <p class="hint" id="cfg">1) Upload small CSV/TXT/JSON → 2) Build Index → 3) Ask</p>

  <div class="zone" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)" onclick="fileInput.click()">
    Drop/click to select files
    <input id="fileInput" type="file" multiple style="display:none" onchange="uploadFiles(this.files)"/>
  </div>
  <pre id="files" class="hint"></pre>

  <div style="margin-top:8px">
    <button class="btn" onclick="buildIndex()">Build Index</button>
    <span id="buildOut" class="hint"></span>
  </div>

  <div class="chat" id="chatBox">
    <div id="msgs"></div>
    <div class="row" style="margin-top:8px">
      <input id="q" type="text" placeholder="Ask your data..." />
      <button class="btn" onclick="ask()">Ask</button>
    </div>
  </div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const filesOut  = document.getElementById('files');
const msgs      = document.getElementById('msgs');

function dragOverHandler(event){ event.preventDefault(); }
function dropHandler(event){ event.preventDefault(); uploadFiles(event.dataTransfer.files); }

async function uploadFiles(fs){
  let fd = new FormData();
  for (let f of fs) fd.append('files', f);
  const r = await fetch('/upload', { method:'POST', body: fd });
  const j = await r.json();
  filesOut.textContent = j.message || JSON.stringify(j);
}

async function buildIndex(){
  document.getElementById('buildOut').textContent = "Building...";
  const r = await fetch('/build_index', {
    method:'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ path: './uploads' })
  });
  const j = await r.json();
  document.getElementById('buildOut').textContent =
    (j.status ? ("Index ready ("+j.n_docs+" docs)") : (j.detail||j.error||JSON.stringify(j)));
}

function addMsg(txt, who) {
  const d = document.createElement('div');
  d.className = 'msg ' + (who==='user' ? 'user' : 'bot');
  d.textContent = txt;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

async function ask(){
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  addMsg(q, 'user');
  addMsg('Thinking...', 'bot');
  const url = '/ask?q=' + encodeURIComponent(q) + '&fast=1';
  const r = await fetch(url);
  const j = await r.json();
  const a = j.answer;
  msgs.lastChild.textContent = (typeof a === 'string') ? a : JSON.stringify(a, null, 2);
}
</script>
</body>
</html>
